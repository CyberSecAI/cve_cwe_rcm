<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWE Hierarchy Sunburst Diagram</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        .info-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 400px;
            height: 800px;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        h1, h2 {
            margin-top: 0;
            color: #333;
        }
        
        .node-info {
            margin-top: 20px;
        }
        
        .breadcrumb {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .cwe-id {
            font-weight: bold;
            color: #0066cc;
        }
        
        .cwe-name {
            font-size: 18px;
            margin: 10px 0;
            word-break: break-word;
        }
        
        .cwe-abstraction {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .children-count {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        path {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1px;
        }
        
        path:hover {
            opacity: 0.8;
        }
        
        .chart-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        #chart {
            width: 100%;
            min-height: 800px;
        }
    </style>
</head>
<body>
    <h1>CWE Hierarchy Interactive Sunburst Diagram</h1>
    <div class="container">
        <div class="diagram-container">
            <div id="chart"></div>
            <div class="legend" id="legend"></div>
        </div>
        <div class="info-panel">
            <h2>Node Information</h2>
            <div class="node-info">
                <p>Click on any segment to zoom in/out and see details here.</p>
                <p>The diagram shows 663 CWE (Common Weakness Enumeration) nodes organized hierarchically.</p>
            </div>
        </div>
    </div>

    <script>
        // Load the data
        async function loadData() {
            try {
                const response = await window.fs.readFile('cwe_complete_hierarchy.json', { encoding: 'utf8' });
                const data = JSON.parse(response);
                createSunburst(data);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please ensure paste.txt is available.');
            }
        }

        function createSunburst(data) {
            // Clear any existing SVG
            d3.select("#chart").selectAll("*").remove();

            // Dimensions
            const width = 900;
            const height = 900;
            const radius = Math.min(width, height) / 2 - 10;

            // Color scales for different abstraction levels
            const colorScheme = {
                'Pillar': '#e41a1c',
                'Class': '#377eb8',
                'Base': '#4daf4a',
                'Variant': '#984ea3',
                'Compound': '#ff7f00'
            };

            // Create the color scale
            const color = d => {
                if (d.depth === 0) return '#ddd';
                if (!d.data.abstraction) return '#999';
                return colorScheme[d.data.abstraction] || '#999';
            };

            // Create the arc generator
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
                .padRadius(radius / 2)
                .innerRadius(d => d.y0 * radius)
                .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));

            // Create the SVG container
            const svg = d3.select("#chart")
                .append("svg")
                .attr("viewBox", [0, 0, width, height])
                .style("width", "100%")
                .style("height", "auto")
                .style("font", "10px sans-serif");

            const g = svg.append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            // Compute the layout
            const root = d3.hierarchy(data)
                .sum(d => {
                    if (!d.children || d.children.length === 0) return 1;
                    return 0;
                })
                .sort((a, b) => b.value - a.value);

            const partition = d3.partition()
                .size([2 * Math.PI, root.height + 1]);

            partition(root);
            
            root.each(d => d.current = d);

            // Create the arcs
            const path = g.append("g")
                .selectAll("path")
                .data(root.descendants().slice(1))
                .join("path")
                .attr("fill", color)
                .attr("fill-opacity", d => arcVisible(d.current) ? (d.children ? 0.8 : 0.6) : 0)
                .attr("d", d => arc(d.current));

            // Add labels
            const label = g.append("g")
                .attr("pointer-events", "none")
                .attr("text-anchor", "middle")
                .style("user-select", "none")
                .selectAll("text")
                .data(root.descendants().slice(1))
                .join("text")
                .attr("dy", "0.35em")
                .attr("fill-opacity", d => +labelVisible(d.current))
                .attr("transform", d => labelTransform(d.current))
                .text(d => {
                    if (d.data.id) {
                        return d.data.id.split(':')[0];
                    }
                    return d.data.name ? d.data.name.substring(0, 30) : '';
                });

            // Add center circle for zooming out
            const parent = g.append("circle")
                .datum(root)
                .attr("r", radius)
                .attr("fill", "none")
                .attr("pointer-events", "all")
                .on("click", clicked);

            // Event handlers
            path.style("cursor", "pointer")
                .on("click", clicked)
                .on("mouseover", showInfo);

            // Show node information
            function showInfo(event, d) {
                updateInfoPanel(d);
            }

            function clicked(event, p) {
                parent.datum(p.parent || root);

                root.each(d => d.target = {
                    x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                    y0: Math.max(0, d.y0 - p.depth),
                    y1: Math.max(0, d.y1 - p.depth)
                });

                const t = g.transition().duration(750);

                path.transition(t)
                    .tween("data", d => {
                        const i = d3.interpolate(d.current, d.target);
                        return t => d.current = i(t);
                    })
                    .filter(function(d) {
                        return +this.getAttribute("fill-opacity") || arcVisible(d.target);
                    })
                    .attr("fill-opacity", d => arcVisible(d.target) ? (d.children ? 0.8 : 0.6) : 0)
                    .attrTween("d", d => () => arc(d.current));

                label.filter(function(d) {
                    return +this.getAttribute("fill-opacity") || labelVisible(d.target);
                }).transition(t)
                    .attr("fill-opacity", d => +labelVisible(d.target))
                    .attrTween("transform", d => () => labelTransform(d.current));

                updateInfoPanel(p);
            }

            function arcVisible(d) {
                return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
            }

            function labelVisible(d) {
                return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
            }

            function labelTransform(d) {
                const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                const y = (d.y0 + d.y1) / 2 * radius;
                return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
            }

            function updateInfoPanel(d) {
                const breadcrumb = d.ancestors().reverse()
                    .map(d => d.data.id || d.data.name || 'Root')
                    .join(' > ');
                    
                const info = d3.select(".node-info");
                
                let html = `<div class="breadcrumb">${breadcrumb}</div>`;
                
                if (d.data.id) {
                    html += `<div class="cwe-id">${d.data.id}</div>`;
                }
                
                if (d.data.name) {
                    html += `<div class="cwe-name">${d.data.name}</div>`;
                }
                
                if (d.data.abstraction) {
                    html += `<div class="cwe-abstraction">Abstraction: ${d.data.abstraction}</div>`;
                }
                
                html += `<div class="children-count">`;
                if (d.children) {
                    html += `Children: ${d.children.length}`;
                } else {
                    html += 'Leaf node';
                }
                html += `</div>`;
                
                if (d.depth > 0) {
                    html += `<p><em>Click to zoom ${d.children ? 'in' : 'out'}</em></p>`;
                }
                
                info.html(html);
            }

            // Create legend
            const legend = d3.select("#legend");
            Object.entries(colorScheme).forEach(([abstraction, color]) => {
                legend.append("div")
                    .attr("class", "legend-item")
                    .html(`
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${abstraction}</span>
                    `);
            });

            // Initial info panel update
            updateInfoPanel(root);
        }

        // Initialize the visualization
        loadData();
    </script>
</body>
</html>