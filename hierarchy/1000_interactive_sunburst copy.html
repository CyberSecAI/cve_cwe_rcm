<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWE Hierarchy Sunburst Diagram</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        .info-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 400px;
            height: 800px;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        h1, h2 {
            margin-top: 0;
            color: #333;
        }
        
        .node-info {
            margin-top: 20px;
        }
        
        .breadcrumb {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .cwe-id {
            font-weight: bold;
            color: #0066cc;
        }
        
        .cwe-name {
            font-size: 18px;
            margin: 10px 0;
            word-break: break-word;
        }
        
        .cwe-abstraction {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .children-count {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        path {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1px;
        }
        
        path:hover {
            opacity: 0.8;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        #chart {
            width: 100%;
            min-height: 800px;
        }
    </style>
</head>
<body>
    <h1>CWE Hierarchy Interactive Sunburst Diagram</h1>
    <div class="container">
        <div class="diagram-container">
            <div id="chart"></div>
            <div class="legend" id="legend"></div>
        </div>
        <div class="info-panel">
            <h2>Node Information</h2>
            <div class="node-info">
                <p>Click on any segment to zoom in/out and see details here.</p>
                <p>The diagram shows 663 CWE (Common Weakness Enumeration) nodes organized hierarchically.</p>
            </div>
        </div>
    </div>

    <script>
        // Load the data
        async function loadData() {
            try {
                const response = await fetch('./cwe_complete_hierarchy.json');
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const data = await response.json();
                createSunburst(data);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please ensure cwe_complete_hierarchy.json is available.');
            }
        }

        function createSunburst(data) {
            // Clear any existing SVG
            d3.select("#chart").selectAll("*").remove();

            // Dimensions
            const width = 900;
            const height = 900;
            const radius = Math.min(width, height) / 2;

            // Color scales for different abstraction levels
            const colorScheme = {
                'Pillar': '#e41a1c',
                'Class': '#377eb8',
                'Base': '#4daf4a',
                'Variant': '#984ea3',
                'Compound': '#ff7f00'
            };

            // Create the color scale
            const color = d => {
                if (!d.depth) return "transparent";
                if (!d.data.abstraction) return '#999';
                return colorScheme[d.data.abstraction] || '#999';
            };

            // Create the SVG container
            const svg = d3.select("#chart")
                .append("svg")
                .attr("viewBox", [-width / 2, -height / 2, width, height])
                .attr("width", width)
                .attr("height", height)
                .style("font", "10px sans-serif");

            // Create the hierarchy
            const root = d3.hierarchy(data)
                .sum(d => d.value || 1)
                .sort((a, b) => b.value - a.value);

            // Create partition layout
            const partition = d3.partition()
                .size([2 * Math.PI, radius]);

            partition(root);

            // Create arc generator
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1 - 1);

            // Create the paths
            const path = svg.append("g")
                .selectAll("path")
                .data(root.descendants())
                .join("path")
                .attr("fill", color)
                .attr("d", arc)
                .style("cursor", "pointer")
                .on("click", clicked)
                .on("mouseover", showInfo);

            path.append("title")
                .text(d => `${d.ancestors().map(d => d.data.name).reverse().join("/")}\n${d.value}`);

            // Create labels
            const label = svg.append("g")
                .attr("pointer-events", "none")
                .attr("text-anchor", "middle")
                .style("user-select", "none")
                .selectAll("text")
                .data(root.descendants().filter(d => d.depth && (d.y0 + d.y1) / 2 * (d.x1 - d.x0) > 10))
                .join("text")
                .attr("transform", d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr("dy", "0.35em")
                .text(d => d.data.id ? d.data.id.split(':')[0] : d.data.name);

            // Zoom function
            function clicked(event, p) {
                const t = svg.transition().duration(750);

                // Rescale outside angles to match the new layout
                const root2 = d3.hierarchy(data)
                    .sum(d => d.value || 1)
                    .sort((a, b) => b.value - a.value);
                
                partition(root2);

                root2.each(d => {
                    d.current = d;
                });

                // When zooming in, interpolate the scales
                root2.each(d => {
                    const x0 = Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0)));
                    const x1 = Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0)));
                    d.target = {
                        x0: x0 * 2 * Math.PI,
                        x1: x1 * 2 * Math.PI,
                        y0: Math.max(0, d.y0 - p.y0),
                        y1: Math.max(0, d.y1 - p.y0)
                    };
                });

                const transition = svg.transition().duration(750);

                // Update paths
                path.transition(transition)
                    .tween("data", d => {
                        const i = d3.interpolate(d.current, d.target || d);
                        return t => d.current = i(t);
                    })
                    .attrTween("d", d => () => arc(d.current));

                // Update labels
                label.transition(transition)
                    .attrTween("opacity", d => () => {
                        return d.target && (d.target.y1 - d.target.y0) * (d.target.x1 - d.target.x0) > 0.03 ? 1 : 0;
                    })
                    .attrTween("transform", d => () => {
                        if (!d.current) return "";
                        const x = (d.current.x0 + d.current.x1) / 2 * 180 / Math.PI;
                        const y = (d.current.y0 + d.current.y1) / 2;
                        return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                    });

                updateInfoPanel(p);
            }

            // Show node information
            function showInfo(event, d) {
                updateInfoPanel(d);
            }

            function updateInfoPanel(d) {
                const breadcrumb = d.ancestors().reverse()
                    .map(d => d.data.id || d.data.name || 'Root')
                    .join(' > ');
                    
                const info = d3.select(".node-info");
                
                let html = `<div class="breadcrumb">${breadcrumb}</div>`;
                
                if (d.data.id) {
                    html += `<div class="cwe-id">${d.data.id}</div>`;
                }
                
                if (d.data.name) {
                    html += `<div class="cwe-name">${d.data.name}</div>`;
                }
                
                if (d.data.abstraction) {
                    html += `<div class="cwe-abstraction">Abstraction: ${d.data.abstraction}</div>`;
                }
                
                html += `<div class="children-count">`;
                if (d.children) {
                    html += `Children: ${d.children.length}`;
                } else {
                    html += 'Leaf node';
                }
                html += `</div>`;
                
                if (d.depth > 0) {
                    html += `<p><em>Click to zoom ${d.children ? 'in' : 'out'}</em></p>`;
                }
                
                info.html(html);
            }

            // Create legend
            const legend = d3.select("#legend");
            Object.entries(colorScheme).forEach(([abstraction, color]) => {
                legend.append("div")
                    .attr("class", "legend-item")
                    .html(`
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${abstraction}</span>
                    `);
            });

            // Initial info panel update
            updateInfoPanel(root);
        }

        // Initialize the visualization
        loadData();
    </script>
</body>
</html>